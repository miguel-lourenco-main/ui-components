# GitLab CI/CD configuration for Next.js static export to GitLab Pages
# Uses GitLab Pages Parallel Deployments for branch-specific preview URLs
image: node:18

# Define variables
variables:
  NODE_ENV: production
  CI_COMMIT_REF_SLUG: $CI_COMMIT_REF_SLUG

# Cache node_modules for faster builds
cache:
  paths:
    - node_modules/
    - .next/cache/

# Define stages
stages:
  - build
  #- test
  - deploy

# Build stage for all branches
build:
  stage: build
  before_script:
    - npm install -g pnpm
    - pnpm install --frozen-lockfile
    - pnpm run build-registry
  script:
    - echo "Environment variables for debugging:"
    - echo "NODE_ENV=$NODE_ENV"
    - echo "CI_COMMIT_REF_SLUG=$CI_COMMIT_REF_SLUG"
    - echo "CI_DEFAULT_BRANCH=$CI_DEFAULT_BRANCH"
    - pnpm run type-check
    - pnpm run lint
    - pnpm run build
  artifacts:
    paths:
      - out/
    expire_in: 1 hour
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: never
    - when: always

# Test stage - runs e2e tests against built static files
test:
  stage: test
  before_script:
    - npm install -g pnpm
    - pnpm install --frozen-lockfile
    - npm install -g serve
    - echo "Installing Playwright browsers..."
    - pnpm exec playwright install --with-deps chromium
  script:
    - echo "Creating directory structure to match expected paths..."
    - if [ "$CI_COMMIT_REF_SLUG" != "main" ]; then
        mkdir -p public/$CI_COMMIT_REF_SLUG;
        cp -r out/* public/$CI_COMMIT_REF_SLUG/;
        cp -r out/index.html public/index.html;
      else
        mkdir -p public;
        cp -r out/* public/;
      fi
    # Remove the redundant lines that always execute
    - ls -la public/
    - echo "Starting static file server on port 3000..."
    - serve -s public -l 3000 &
    - sleep 5  # Give the server time to start
    - echo "Testing server response..."
    - curl -f http://localhost:3000/$CI_COMMIT_REF_SLUG/ || echo "Server not responding properly"
    - echo "Verifying website content..."
    - curl -s http://localhost:3000/$CI_COMMIT_REF_SLUG/ | grep -q "<html" || (echo "ERROR - No HTML content found" && exit 1)
    - curl -s http://localhost:3000/$CI_COMMIT_REF_SLUG/ | grep -q "<title" || (echo "ERROR - No title tag found" && exit 1)
    - curl -s http://localhost:3000/$CI_COMMIT_REF_SLUG/ | grep -q "next" || (echo "ERROR - Next.js content not found" && exit 1)
    - echo "✅ Website is serving properly"
    - echo "Testing component registry availability..."
    - curl -f http://localhost:3000/$CI_COMMIT_REF_SLUG/generated-registry.json || (echo "ERROR - Component registry not available" && exit 1)
    - echo "✅ Component registry is accessible"
    - echo "Running Playwright tests..."
    - pnpm exec playwright test --workers=1 || exit 1
  after_script:
    - echo "Cleaning up background processes..."
    - pkill -f "serve" || true  # Kill the serve process, ignore if already dead
  dependencies:
    - build
  artifacts:
    when: always
    paths:
      - playwright-report
    expire_in: 2 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: never
    - when: always

# Deploy to GitLab Pages - Production (main branch)
pages:
  stage: deploy
  script:
    - echo "Deploying to GitLab Pages Production..."
    - echo "Production URL - ${CI_PAGES_URL}"
    - ls -la out/  # Debug: List contents of out directory
    - mkdir -p public
    - cp -r out/* public/  # Copy contents of out directory to public directory
    - ls -la public/  # Debug: List contents of public directory
    - ls -la public/_next/static/chunks/ || echo "No chunks directory found"
  artifacts:
    paths:
      - public/
    expire_in: never
  dependencies:
    - build
    #- test
  environment:
    name: production
    url: $CI_PAGES_URL
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: never
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Deploy to GitLab Pages - Feature Branches (parallel deployments)
pages-review:
  stage: deploy
  script:
    - echo "Deploying parallel deployment for branch $CI_COMMIT_REF_SLUG"
    - echo "Review URL - ${CI_PAGES_URL}/$CI_COMMIT_REF_SLUG/"
    - ls -la out/  # Debug: List contents of out directory
    - mkdir -p public
    - cp -r out/* public/  # Copy contents of out directory to public directory
    - ls -la public/  # Debug: List contents of public directory
    - ls -la public/_next/static/chunks/ || echo "No chunks directory found"
  artifacts:
    paths:
      - public/
    expire_in: 1 week
  pages:
    path_prefix: "$CI_COMMIT_REF_SLUG"  # Creates URL: site.com/branch-name/
    expire_in: 1 week  # Auto-cleanup after 1 week
  dependencies:
    - build
    - test
  environment:
    name: review/$CI_COMMIT_REF_SLUG
    url: $CI_PAGES_URL/$CI_COMMIT_REF_SLUG/
    on_stop: stop_review
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: never
    - if: $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH
    
# Stop review environment (automatic cleanup when branch is deleted)
stop_review:
  stage: deploy
  script:
    - echo "Stopping review environment for $CI_COMMIT_REF_SLUG"
  environment:
    name: review/$CI_COMMIT_REF_SLUG
    action: stop
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: never
    - if: $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH
      when: manual